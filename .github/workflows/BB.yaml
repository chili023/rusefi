name: Generate Headers and Check Output Channels

on:
  push:
    branches:
      - engine_hours
  workflow_dispatch:

jobs:
  generate-headers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Install mtools (for create_image.sh)
        run: sudo apt-get update && sudo apt-get install -y mtools

      - name: Set ABSOLUTE_BOARD_DIR
        run: echo "ABSOLUTE_BOARD_DIR=$(pwd)/config/boards/nucleo_h743" >> $GITHUB_ENV

      - name: Run generateHeaders
        run: |
          cd java_tools
          ./gradlew generateHeaders --stacktrace

      - name: Check output_channels_generated.h
        run: |
          if [ ! -f firmware/live_data_generated/output_channels_generated.h ]; then
            echo "❌ output_channels_generated.h not created"
            exit 1
          fi
          grep engine_hours firmware/live_data_generated/output_channels_generated.h || {
            echo "❌ engine_hours fields not found in output_channels_generated.h"
            exit 1
          }
